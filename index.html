<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D無限生成ゲーム</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
        font-family: sans-serif;
      }
      canvas {
        display: block;
      }
      #canvasWrapper {
        width: 100vw;
        height: 100vh;
        cursor: none;
      }
      #ui {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 14px;
        pointer-events: none;
      }
      #message {
        margin-top: 5px;
        color: #ffff00;
      }
      /* --- Step 21 で追加したコード: インベントリUIのスタイル --- */
      #inventory {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-size: 14px;
      }
      .item {
        margin: 2px 0;
      }
      /* --- Step 21 のコード ここまで --- */
    </style>
  </head>
  <body>
    <div id="canvasWrapper">
      <canvas id="gameCanvas"></canvas>
    </div>
    <div id="ui">
      <div>位置: <span id="playerPos">0, 0, 0</span></div>
      <div>チャンク: <span id="playerChunk">0, 0, 0</span></div>
      <div>OnGround: <span id="onGround">true</span></div>
      <div id="message"></div>
    </div>
    <!-- --- Step 21 で追加したコード: インベントリUI --- -->
    <div id="inventory">
      <div>インベントリ:</div>
      <div class="item">青りんご: <span id="inv_apple">0</span></div>
      <div class="item">棒: <span id="inv_stick">0</span></div>
      <div>(Cキーでクラフト)</div>
    </div>
    <!-- --- Step 21 のコード ここまで --- -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.168.0/build/three.module.js",
          "three/addons/": "https://unpkg.com/three@0.168.0/examples/jsm/",
          "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
        }
      }
    </script>
    <script type="module">
      // Step 21: 基本的なクラフトシステムの追加
      import * as THREE from "three";
      import { ImprovedNoise } from "three/addons/math/ImprovedNoise.js";
      import * as CANNON from "cannon-es";

      const CHUNK_SIZE = 32;
      const TERRAIN_RESOLUTION = 32;
      const RENDER_DISTANCE = 2;

      function worldToChunkCoord(worldCoord) {
        return Math.floor(worldCoord / CHUNK_SIZE);
      }

      function calculateVisibleChunks(
        playerChunkX,
        playerChunkY,
        playerChunkZ
      ) {
        const chunksToLoad = [];
        for (let dx = -RENDER_DISTANCE; dx <= RENDER_DISTANCE; dx++) {
          for (let dy = -RENDER_DISTANCE; dy <= RENDER_DISTANCE; dy++) {
            for (let dz = -RENDER_DISTANCE; dz <= RENDER_DISTANCE; dz++) {
              const cx = playerChunkX + dx;
              const cy = playerChunkY + dy;
              const cz = playerChunkZ + dz;
              chunksToLoad.push({ cx, cy, cz });
            }
          }
        }
        return chunksToLoad;
      }

      const playerPosition = new THREE.Vector3(50, 1, -25);
      const PLAYER_SPEED = 100.0;
      const JUMP_FORCE = 4.0;
      const GRAVITY = 20.0;

      const scene = new THREE.Scene();
      let playerChunkX = worldToChunkCoord(playerPosition.x);
      let playerChunkY = worldToChunkCoord(playerPosition.y);
      let playerChunkZ = worldToChunkCoord(playerPosition.z);

      console.log(
        `プレイヤーの初期位置: (${playerPosition.x}, ${playerPosition.y}, ${playerPosition.z}) m`
      );
      console.log(
        `プレイヤーの初期所属チャンク: (${playerChunkX}, ${playerChunkY}, ${playerChunkZ})`
      );

      const loadedChunks = new Map();
      const loadedChests = [];
      const loadedTrolls = [];
      let jumpKeyJustPressed = false;

      // --- Step 21 で追加したコード: 簡易インベントリ ---
      const playerInventory = {
        "青りんご": 0,
        "棒": 0
      };

      // インベントリUI要素の取得
      const invAppleElement = document.getElementById("inv_apple");
      const invStickElement = document.getElementById("inv_stick");

      // インベントリUIを更新する関数
      function updateInventoryUI() {
          invAppleElement.textContent = playerInventory["青りんご"];
          invStickElement.textContent = playerInventory["棒"];
      }

      // アイテムをインベントリに追加する関数
      function addItemToInventory(itemName, quantity = 1) {
          if (playerInventory.hasOwnProperty(itemName)) {
              playerInventory[itemName] += quantity;
              console.log(`アイテム取得: ${itemName} x${quantity}`);
              updateInventoryUI(); // UI更新
          } else {
              console.warn(`不明なアイテム: ${itemName}`);
          }
      }
      // --- Step 21 のコード ここまで ---

      // --- Step 21 で追加したコード: クラフトレシピ ---
      const craftingRecipes = {
          "棒": { "青りんご": 2 } // 棒を作るには青りんご2個が必要
          // 他のレシピもここに追加可能
          // 例: "剣": { "棒": 2, "鉄インゴット": 1 }
      };

      // アイテムをクラフトする関数
      function craftItem(itemName) {
          const recipe = craftingRecipes[itemName];
          if (!recipe) {
              console.log(`クラフトレシピが見つかりません: ${itemName}`);
              return false;
          }

          // 必要アイテムが揃っているかチェック
          let canCraft = true;
          for (const ingredient in recipe) {
              if (playerInventory[ingredient] < recipe[ingredient]) {
                  canCraft = false;
                  break;
              }
          }

          if (canCraft) {
              // 必要アイテムを減らす
              for (const ingredient in recipe) {
                  playerInventory[ingredient] -= recipe[ingredient];
              }
              // クラフトされたアイテムを追加
              addItemToInventory(itemName, 1); // addItemToInventory でUIも更新
              console.log(`クラフト成功: ${itemName}`);
              showMessage(`クラフト成功: ${itemName}`);
              return true;
          } else {
              console.log(`クラフト失敗: ${itemName} の材料が足りません`);
              showMessage(`クラフト失敗: 材料が足りません`);
              return false;
          }
      }
      // --- Step 21 のコード ここまで ---

      // ... (音声関連, getChunkKey, createNoiseTerrain, getTerrainHeightAt, createChest, placeChestsInChunk, createTroll, placeTrollsInChunk, placeTreesInChunk, createTree, loadChunk, unloadChunk, chunkToWorldCenter, createChunkWireframe, toggleViewMode, camera, renderer, lights, playerMesh, camera setup, mouse controls, axesHelper) ...

      // --- 物理エンジン関連 ---
      let physicsWorld = null;
      let playerBody = null;
      let isOnGround = true;

      function initPhysics() {
        physicsWorld = new CANNON.World();
        physicsWorld.gravity.set(0, -GRAVITY, 0);
        physicsWorld.broadphase = new CANNON.NaiveBroadphase();
        physicsWorld.solver.iterations = 10;
        console.log("Cannon.js 物理ワールドを初期化しました。");

        const playerShape = new CANNON.Cylinder(0.5, 0.5, 2, 16);
        playerBody = new CANNON.Body({ mass: 5 });
        playerBody.addShape(playerShape);
        playerBody.position.copy(playerPosition);
        playerBody.linearDamping = 0.1;
        playerBody.fixedRotation = true;
        playerBody.updateMassProperties();
        physicsWorld.addBody(playerBody);

        playerBody.addEventListener("collide", function (e) {
          const contact = e.contact;
          if (contact.ni.y > 0.5) {
            isOnGround = true;
          }
        });
      }

      function updatePhysics(deltaTime) {
        if (physicsWorld) {
          physicsWorld.step(1 / 60, deltaTime, 3);
          if (playerBody && playerMesh) {
            playerMesh.position.copy(playerBody.position);
          }
        }
      }
      // --- 物理エンジン関連 ここまで ---

      const keyState = {};
      window.addEventListener('keydown', (event) => {
            if (event.code === 'Space') {
                if (!keyState['Space']) {
                    jumpKeyJustPressed = true;
                }
            }
            keyState[event.code] = true;

            if (event.code === 'KeyV') { toggleViewMode(); }
            if (event.code === 'KeyE') { interact(); }
            if (event.code === 'KeyM') { toggleBGM(); }
            // --- Step 21 で追加したコード: クラフトキー ---
            if (event.code === 'KeyC') {
                 craftItem("棒"); // 例: Cキーで棒をクラフト
            }
            // --- Step 21 のコード ここま
        });
        window.addEventListener('keyup', (event) => {
            keyState[event.code] = false;
            if (event.code === 'Space') {
                jumpKeyJustPressed = false;
            }
        });

      const clock = new THREE.Clock();

      // --- UI要素の取得 ---
      const playerPosElement = document.getElementById("playerPos");
      const playerChunkElement = document.getElementById("playerChunk");
      const onGroundElement = document.getElementById("onGround");
      const messageElement = document.getElementById("message");
      let messageTimeout = null;
      // --- UI要素の取得 ここまで ---

      function interact() {
        const INTERACT_DISTANCE = 3.0;

        let closestChest = null;
        let closestTroll = null;
        let closestDistanceSq = Infinity;

        for (const chest of loadedChests) {
          const distanceSq = playerMesh.position.distanceToSquared(
            chest.position
          );
          if (distanceSq < closestDistanceSq) {
            closestDistanceSq = distanceSq;
            closestChest = chest;
          }
        }

        for (const troll of loadedTrolls) {
          const distanceSq = playerMesh.position.distanceToSquared(
            troll.position
          );
          if (distanceSq < closestDistanceSq) {
            closestDistanceSq = distanceSq;
            closestChest = null;
            closestTroll = troll;
          }
        }

        if (
          closestChest &&
          closestDistanceSq <= INTERACT_DISTANCE * INTERACT_DISTANCE
        ) {
          // --- Step 21 で変更したコード: アイテム取得 ---
          // showMessage("チェストを開けました！中身は青りんごです。");
          // playSound("chest");
          addItemToInventory("青りんご", 1); // アイテムを1つ取得
          playSound("chest");
          showMessage("チェストを開けました！青りんごを1つ入手しました。");
          // --- Step 21 のコード ここま
        } else if (
          closestTroll &&
          closestDistanceSq <= INTERACT_DISTANCE * INTERACT_DISTANCE
        ) {
          showMessage(
            "トロールに話しかけました。「こんにちは、冒険者よ！何か用かい？」"
          );
          playSound("troll");
        }
      }

      function showMessage(text) {
        messageElement.textContent = text;
        if (messageTimeout) {
          clearTimeout(messageTimeout);
        }
        messageTimeout = setTimeout(() => {
          messageElement.textContent = "";
          messageTimeout = null;
        }, 3000);
      }

      function animate() {
            requestAnimationFrame(animate);

            const delta = clock.getDelta();

            updatePhysics(delta);

            // ... (プレイヤーの移動とジャンプ処理) ...

            // ... (NPC反応, UI更新, チャンク更新ロジック, render) ...

            // --- Step 21 で追加したコード: フレーム終了時にジャンプキーの「押された瞬間」フラグをリセット ---
            jumpKeyJustPressed = false;
            // --- Step 21 のコード ここまで ---
        }

      // 最初の初期化
      initSounds();
      initPhysics();
      const initialVisibleChunks = calculateVisibleChunks(
        playerChunkX,
        playerChunkY,
        playerChunkZ
      );
      initialVisibleChunks.forEach((chunkCoord) => {
        loadChunk(chunkCoord);
      });
      console.log(
        `初期ロード: ${initialVisibleChunks.length} 個のチャンクをロードしました。`
      );

      // --- Step 21 で追加したコード: 初期インベントリUI更新 ---
      updateInventoryUI(); // 初期状態（0個）でUIを更新
      // --- Step 21 のコード ここまで ---

      animate();

      // ... (リサイズ処理) ...

      console.log(
        "Scene, Camera, Renderer, Player, Dynamic Chunk Loading, Complex Noise-based Terrain, Full Physics (Cannon.js), Sound, and Basic Crafting System initialized."
      );
      console.log(
        "Click to lock pointer. WASD to move. Mouse to look around. Press 'V' to toggle view mode (FPS/TPS). Press 'E' to interact. Press 'Space' to jump. Press 'M' to toggle BGM. Press 'C' to craft a stick."
      );
    </script>
  </body>
</html>